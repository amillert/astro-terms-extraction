Velocity reconstruction with the cosmic microwave background and galaxy surveys
The kinetic Sunyaev Zel’dovich (kSZ) and moving lens effects, secondary contributions to the cosmic microwave background (CMB), carry significant cosmological information due to their de- pendence on the large-scale peculiar velocity field. Previous work identified a promising means of extracting this cosmological information using a set of quadratic estimators for the radial and trans- verse components of the velocity field. These estimators are based on the statistically anisotropic components of the cross-correlation between the CMB and a tracer of large scale structure, such as a galaxy redshift survey. In this work, we assess the challenges to the program of velocity recon- struction posed by various foregrounds and systematics in the CMB and galaxy surveys, as well as biases in the quadratic estimators. To do so, we further develop the quadratic estimator formalism and implement a numerical code for computing properly correlated spectra for all the components of the CMB (primary/secondary blackbody components and foregrounds) and a photometric redshift survey, with associated redshift errors, to allow for accurate forecasting. We create a simulation framework for generating realizations of properly correlated CMB maps and redshift binned galaxy number counts, assuming the underlying fields are Gaussian, and use this to validate a velocity reconstruction pipeline and assess map-based systematics such as masking. We highlight the most significant challenges for velocity reconstruction, which include biases associated with: modelling errors, characterization of redshift errors, and coarse graining of cosmological fields on our past light cone. Despite these challenges, the outlook for velocity reconstruction is quite optimistic, and we use our reconstruction pipeline to confirm that these techniques will be feasible with near-term CMB experiments and photometric galaxy redshift surveys.


I.	INTRODUCTION

Measurements of the Cosmic Microwave Background (CMB) radiation are entering an unprecedented era of high-resolution and low noise. Existing experiments such as the Atacama Cosmology Telescope [1] (ACT) and South Pole Telescope [2] (SPT), near-term experiments such as Simons Observatory [3] (SO), and future experiments such as CMB-S4 [4] and CMB-HD [5] will map the small-angular scale anisotropies in CMB temperature and polarization with steadily increasing precision. Many of the new opportunities on this frontier arise from CMB secondaries: temperature and polarization anisotropies associated with the gravitational or electromagnetic scattering of CMB photons from structure at low redshift. For example, existing data from ACT has been used to reconstruct the lensing potential at high fidelity over a significant fraction of the sky [6], and future experiments will enable precision cosmological constraints on e.g. neutrino masses using information from these reconstructions. Simultaneously, galaxy surveys will map ever larger volumes with increasing numbers of spectroscopic redshifts and photometric redshifts of improving precision; near-term surveys include The Rubin Observatory Legacy Survey of Space and Time [7] (LSST), Dark Energy Spectroscopic Instrument [8] (DESI), and Euclid [9]. Existing galaxy surveys have been combined with CMB datasets to make a (statistically) significant detection of the kinetic Sunyaev Zel’dovich (kSZ) effect [10–16], temperature anisotropies induced by the scattering of CMB photons from free electrons in bulk motion. Again, future experiments will allow for precision science using the kSZ effect (as described in more detail below). Beyond lensing and kSZ, there are other CMB secondaries in temperature, including the moving lens (ML) effect, [17, 18], other non-linear components of the integrated Sachs Wolfe effect [19– 21], patchy reionization [22], and rotational kSZ [23]; additional effects exist in the polarized component of the CMB (e.g. [24, 25]). Assessing the detectability of CMB secondaries and their utility in improving our understanding of cosmology is an active area of investigation, to which the present paper aims to contribute. In this paper, we focus on the kSZ and the ML effects. Schematically, the kSZ temperature anisotropies are given by a line-of-sight integral over the product of the radial component of the peculiar velocity field 1 and the electron density; the ML temperature anisotropies are a line-of-sight integral of the transverse gradient of the gravitational potential and the transverse components of the peculiar velocity field. These secondaries contain significant cosmological information owing to their dependence on large-scale bulk velocities.
One way of accessing this information is through the technique of kSZ tomography [26–29]: tomographic reconstruction of the radial velocity using the CMB and a tracer of large scale structure.  A  quadratic estimator for the radial velocity field was developed in Ref. [28],  which relies on the anisotropic cross- power between a galaxy redshift survey and the kSZ component of the CMB. Such a reconstruction can be used as a general-purpose cosmological observable, and is in principle a powerful probe of primordial non-Gaussianity [30], relativistic effects in galaxy surveys [31],  modified gravity [32],  CMB anomalies [33], and isocurvature perturbations [34, 35].
A quadratic estimator for the transverse velocity based on the correlation between a galaxy redshift survey and the ML component of the CMB temperature anisotropies was presented in Ref. [36]. For consistency of terminology we will refer to the tomographic reconstruction transverse velocities using the ML effect as ‘ML tomography’. The ML effect is roughly an order  of  magnitude  smaller  than  kSZ  on  small  angular scales ( arcmin), so while kSZ has been detected at the greater than 5σ level, current datasets are not yet sufficient to have made a detection of the ML effect. Even so, the ML effect will be measured with high signal-to-noise with upcoming CMB experiments [36–38].   As discussed in Ref. [39],  transverse velocities from ML tomography, when combined with galaxy measurements,  can provide competitive constraints on the combination of the linear-theory growth rate f and the amplitude of matter fluctuations σ8 on the scale
of 8h−1Mpc, comparable to the scenario where the redshift-space distortions (RSDs) are modelled with high accuracy. This parameter is useful for studying a large range of physics, including dark energy [40], modified
gravity [41] and the effects of neutrino mass [42]. Precision measurement of fσ8 also allows one to use the kSZ effect to learn about astrophysics, such as the characteristics of the electron density profiles around halos, by breaking degeneracies in kSZ between the electron-scattering optical depth and the growth rate [29].
The formalism for velocity reconstruction using the kSZ effect is reasonably mature, and several approaches have been developed to analyze simulations and forecast the capabilities of kSZ tomography in future ex- periments. In the ‘Box Picture’ of [29], the kSZ effect is estimated from the momentum field along one direction in a 3D box at the median redshift of a galaxy survey. This formulation is convenient since it sidesteps spherical projection effects and allows one to work in the familiar Fourier domain. This approach is a good approximation for reconstruction on relatively small sky areas and over limited ranges in redshift. The study of various systematics is straightforward in the Box Picture, and Ref. [29] estimated the impact of redshift space distortions and photometric redshift errors on velocity reconstruction. Subsequent work explored important contributions to the variance of the quadratic estimator [43] and explored the effect of the optical depth bias [29, 43, 44], the uncertainty in the reconstruction induced by imperfect modelling of the correlation between the distribution of electrons and galaxies. Ref. [43] validated the quadratic es- timator in the Box Picture using a suite of N-body simulations, and demonstrated that the constraints on primordial non-Gaussianity forecasted in Ref. [30] could be realized in practice.  It is, however, cumbersome to accurately incorporate redshift evolution, relativistic contributions to the kSZ effect, and large sky area in the Box Picture.
In the ‘Light Cone Picture’ introduced in Refs. [26, 28], kSZ tomography is formulated in terms of observ- ables on our past light cone. In the Light Cone Picture, it is straightforward to incorporate redshift evolution and relativistic contributions to the radial velocity field (promoting it to the remote dipole field).  However, it is less straightforward to incorporate photometric redshift errors and other systematics.  Another drawback of the Light Cone Picture are the cumbersome projection integrals, which make computing observables more expensive. The quadratic estimator in the Light Cone Picture was validated using N-body simulations in Ref. [45], where the impact of gravitational lensing, redshift space distortions, and the non-linear evolution of structure were taken into account. In an application to future datasets, the Light Cone Picture has a number of advantages. Perhaps most importantly, it is formulated in terms of direct observables (e.g. fields on the sphere), making contact between theory and observation precise. The signal to noise of the reconstruction is largest on the largest scales, where the redshift evolution and projection effects captured by the Light Cone


1 More precisely, the kSZ temperature anisotropies are sourced by the remote dipole field: the radially-projected CMB dipole observed along our past light cone [26].
 

Picture are most important.
A primary goal of this paper is to further develop the formalism for the Light Cone Picture for both kSZ and ML tomography. We begin by developing a self-consistent theoretical framework based on the Halo Model [46] for predicting the auto and cross spectra of fields on the light cone, including dark matter density, electron density, velocities, galaxy number counts, the Newtonian potential and its time derivative, as well as the frequency-dependent contribution to the CMB from the thermal Sunyaev Zel’dovich (tSZ) effect and the Cosmic Infrared Background (CIB). We employ a coarse-graining scheme in radial distance along the light cone based on Haar wavelets and use this complete basis to perform line of sight integrals for the kSZ, ML, ISW, lensing, tSZ, CIB, and binned galaxy number counts. The contributions we include for the CMB represent the most important (in terms of the amplitude of power spectra) blackbody and frequency dependent components. A challenging aspect of kSZ and ML tomography is that large scale fields are reconstructed from small angular scale anisotropies, implying one must model both small and large scales well. We develop tools to accurately compute spectra from the dipole down to sub-arcminute angular scales. We quantify the level of coarse graining given a fiducial CMB experiment and galaxy survey that will be necessary to capture the relevant cosmological information accessible using kSZ and ML tomography.
Another goal of this paper is to assess the impact of various foregrounds and systematics on kSZ and ML tomography. Previous work has largely neglected these effects in forecasts. We assess the impact of extragalactic foregrounds by forecasting the level of residuals in auto and cross-spectra given a fiducial CMB experiment and the resulting effect on the variance of the quadratic estimators. We develop a formalism, analogous to bias hardening in CMB lensing [47], to remove biases associated with photometric redshift errors, and compute the variance of the resulting unbiased estimators in both a redshift-binned and principal component basis. The kSZ and ML quadratic estimators are biased by other sources of statistical anisotropy in the CMB-galaxy cross-power such as CMB lensing. We confirm that these biases are small enough to be neglected in near-term experiments. A related systematic arises from redshift calibration errors on large angular scales, or any other effect that modulates the amplitude of the underlying statistically isotropic CMB anisotropies or galaxy number counts. This leads to a statistically anisotropic modulation of the CMB-galaxy cross-power that can bias the kSZ and ML quadratic estimators.  While this is the dominant source of estimator bias, we determine that it is below the estimator variance for the fiducial CMB experiment we consider.
To assess the impact of partial sky coverage for the CMB experiment and galaxy survey, we work with simulations in map space. We develop a numerical framework to produce sets of properly correlated CMB maps and redshift binned galaxy number counts, assuming the underlying fields are Gaussian. We derive and implement a set of real space quadratic estimators and an associated pipeline to reconstruct the radial and transverse velocity fields from an ensemble of simulated CMB maps (including both blackbody components and foreground residuals) and correlated binned galaxy number count maps. We find that no significant bias is introduced by masking, and confirm that the reconstructed power spectra can be approximated by simply scaling by the fraction of the sky that remains unmasked.  For ML tomography,  we highlight a challenge posed by numerical errors associated with spherical harmonic transforms in the low signal to noise regime that near-term experiments will operate in.
Our results suggest that the main limitations on kSZ and ML tomography will be various modelling errors that give rise to a biased reconstruction of the velocity field. The largest among these are biases introduced by photometric redshift errors and mis-modelling of the galaxy-electron cross-power spectra, highlighting areas for future work. With a fixed experimental setup, improvements in the fidelity of the reconstruction can be made through better foreground removal techniques on small angular scales. However, our investigations have not found any effect that seriously impacts the performance of kSZ and ML tomography as presented in previous literature, which is good news for these techniques. As a companion to this paper, we have released a publicly available code:  (Re)construction (C)ode for (C)osmological (O)bservables, ReCCO 2. This code can be used to compute various power spectra, generate properly correlated Gaussian mock maps, and perform radial and transverse velocity reconstruction. We hope that this is a useful tool for future forecasts and data analysis.
The plan of the paper is as follows. In Sec. II, we outline the formalism for kSZ and ML tomography and in Sec. III we outline our construction of various contributions to the CMB and galaxy density field. In Sec. IV
we perform a detailed forecast for a set of fiducial datasets including various biases to the reconstruction. We present and validate a simulation and reconstruction pipeline for the radial and transverse velocity fields in Sec. V, and conclude in Sec. VI. We summarize various technical details in several appendices.

In this section, we describe the formalism for kSZ and ML tomography (velocity reconstruction) in the Light Cone Picture. We begin by reviewing the projection of cosmological fields onto our past light cone. Coarse grained cosmological fields on the light cone constitute the inputs to our estimator formalism, and we outline a coarse graining scheme as well as the statistics of the coarse grained fields. We outline the quadratic estimator formalism, proceeding from the simplest to the most realistic scenario.
Statistically isotropic correlations

The statistically isotropic correlations between µ-binned and integrated light cone moments an conve- niently be expressed in terms of a set of angular auto- and cross-spectra that depend on l and the window labels only. Let’s consider two fields F and G on the light cone, constructed from underlying 4-dimensional fields UF and UG as described in above, and integrated on the line of sight with windows W and W ′ respectively. The cross-spectra is:
Although a brute force computation of the integrals in Eq. 16 is feasible for certain values of l and certain χ ranges, the oscillatory behaviour of the integral kernels make such an approach cumbersome if accuracy across a wide range of multipole moments and redshifts is desired. This is exactly our case, as we aim to have consistent modelling of large-angle and small-angle observables across a large redshift range. The Limber approximation (see e.g. [50]) can be used to simplify the oscillatory integrals and provide accurate spectra under certain circumstances. For our purposes, an implementation of the Limber approximation is challenged by several factors: first, part of our calculations require narrow window functions, which can drive the Limber approximation beyond its regime of validity if the multipole l is not high enough. Second, the Limber approximation only picks up the equal-time contribution to the cross-correlation power spectra (χ1 = χ2)
Here we adopt the ‘Beyond Limber approximation’ method from [52], which separates Eq. 16 into a term suitable for the Limber approximation and a term with separable structure that allows for fast Bessel integrations. We briefly summarize this method in 

 
Our formalism builds upon previous literature [28] in which the contribution from fine modes on the light cone has not been considered and the statistical anisotropy is approximated as only sourced by the bulk modes. This can be a good approximation if N is high enough (how high depends on the radial profile of MA1m1 (χ)); in this paper we will keep these terms and quantify their relevance in the modelling of the temperature-density statistical anisotropy.
 




C.	Quadratic  estimator

In this subsection we discuss how the Π-binned modes appearing in the statistical anisotropy Eq. 29 can be estimated by constructing appropriately weighted sums of products of temperature and density multipoles. The most general case discussed in the previous subsection included statistical anisotropies sourced by the Π-binned  and  Haar-binned  LC  moments  of  a  series  of  modulating  fields  ( M (nˆ, χ) , Q(nˆ, χ) , . . . ).   We  will first consider the simplified case in which there is only one modulating field M (nˆ, χ) and a single Π mode α and derive the quadratic estimator. After that, we progressively add layers of complexity until we reach the most general case.

Let’s start by considering the simple case in which there is only one modulating bulk mode 
principle there are N  bias parameters at each scale L. In the context of kSZ velocity reconstruction, where
the B-field is the optical depth, this multiplicative factor is commonly referred as the optical depth bias; see e.g. Refs. [29, 43, 44, 53]. As discussed in more detail in Sec. IV A 2, the bias does not depend on the scale L over the relevant range for reconstruction, leaving a total of N 2 bias parameters to account for. Note that in the absence of off-diagonal terms in the rotation matrix Eq. 64 (or if these terms are very small), there would only be N bias parameters. This is the assumption that has been made in previous literature utilizing the light cone picture to forecast cosmological constraints, e.g. Refs. [31–33]. We comment on this assumption and the general problem of mitigating the optical depth bias in Sec. IV A 2.


III.	MODELING OF OBSERVABLES

In this paper, we will be interested in statistically anisotropic correlations between various contributions to the observed CMB and a tracer of large scale structure (LSS). Our goal is to use such statistical anisotropies to reconstruct (on large angular scales) a set of modulating fields – here, our focus is on the radial and transverse velocity fields. Our prototype tracer is a photometric galaxy redshift survey, as considered in
e.g. Refs. [26, 28–30]; other tracers such as spectroscopic surveys [29, 30], the Cosmic Infrared Background (CIB) [54], or line-intensity maps [35, 55] are other interesting candidates. Throughout the paper, we assume a fiducial cosmological model consistent with Planck 2018 [56];  in particular, we set:    109As  = 2.2, ns  = 0.965, Ωm = 0.31, Ωb = 0.049, H0 = 68 km s−1 Mpc−1, τ = 0.06 . There is no strong  dependence  on cosmological parameters for any of our conclusions.
When necessary, we present relations in the Newtonian gauge, where at late-times when we can neglect anisotropic stress; the metric is:

Because our Halo Model code calculates perturbations in the synchronous gauge, it is sometimes necessary to relate Newtonian gauge quantities to synchronous gauge ones. For late-times, simple relations can be written for the Newtonian gauge gravitational potential Ψ and the peculiar velocity field v of dark matter in terms of the synchronous gauge dark matter perturbations in Fourier space:


Below we describe in detail the components which have significant cross-correlation with late-time tracers of LSS, since such components must be computed in a self-consistent way. The SW, Doppler, and early ISW contributions ΘpCMB  to the primary CMB do not contribute to the cross correlation with tracers of LSS; we compute their power spectra using CAMB [57]. The reionization kSZ component ΘReI is modelled as a Gaussian field with power spectrum l2Crei/2π = 1µK2. If higher redshift tracers of LSS are considered, then the reionization kSZ can be used to reconstruct the radial velocity field as described in Ref. [58]; in this paper, we focus on tracers of LSS that do not have any significant cross-correlation with reionization kSZ. For the fiducial CMB experiments considered below, including reionization kSZ does not affect any of our results, and we therefore neglect this contribution in our analysis. Galactic foregrounds on the small angular scales relevant to velocity reconstruction are generally sub-dominant to extragalactic foregrounds on a line of sight away from the galactic plane (see e.g. Ref. [59]). We assume that regions with significant galactic contamination can be masked.  Other than considering the effect of a mask, we therefore neglect galactic
foregrounds. 
In Fig. 1, we summarize the blackbody components of our CMB model: the primary CMB, late-time ISW, lensed CMB, kSZ, and ML. Each of these contributions is discussed in more detail in the following sub-sections.  At low-l, the dominant components are the primary CMB and late-time ISW effects.  Crucially, at high-l (l 4 4000), kSZ is the dominant blackbody component of the CMB. In the left panel of Fig. 2, we show the frequency-dependent components of our CMB model, including extragalactic foregrounds and instrumental noise. In the right panel of Fig. 2, we compare the effective noise obtained by using multi- frequency information with the blackbody component of the CMB and with the noise and foregrounds in
 

the ‘cleanest’ channel (for velocity reconstruction) of our fiducial experiment, at 145 GHz. Note that the blackbody CMB dominates the noise and foregrounds below l 4 3000. We assume that multifrequency infor- mation can be used to clean foregrounds using a standard harmonic space internal linear combination (ILC) procedure, described in more detail below. Such a procedure can reduce the level of noise and foregrounds by roughly a factor of 2 at high-l when compared to the 145 GHz channel. Unless otherwise specified, in the analyses to follow we will use the ILC-cleaned CMB generated with the specifications in Table I; we consider a maximum value of lmax = 6000 which roughly corresponds to maps with a HEALPix 5 resolution NSIDE of 2048. We now describe in more detail how we model the various CMB components listed above.

FIG. 2: Left panel: Frequency dependent components of CMB compared to the blackbody component. Colored solid lines correspond to the de-beamed instrumental noise and dashed lines correspond to the CIB+tSZ contribu- tions (including their cross-spectra). Right panel: the ILC-cleaned power spectrum compared to the blackbody component and the full 145 GHz channel.

There are a number of extragalactic foregrounds that contribute to the CMB, whose relative importance depend on the frequency and scale being observed. At low frequencies (4 150 GHz) on arcminute scales, the thermal Sunyaev Zel’dovich (tSZ) effect and radio point sources dominate.  At high frequencies (4 150 GHz) on the same scales, the CIB is the dominant extragalactic foreground. Below, we assume that enough radio point sources can be masked to make tSZ the dominant source at low frequencies. With this assumption,
we include the tSZ and CIB only in our extragalactic foreground model.
We now consider a tracer of the electron overdensity field, which for the purposes of the present paper we take to be the galaxy overdensity field, measured using a photometric redshift survey. Other tracers such as the redshifted 21cm Hydrogen line (or transitions such as CII) measured by line intensity mapping surveys [35, 66], the CIB [54], or the dispersion measure of Fast Radio Bursts [44] have been considered as well. Spectroscopic surveys were considered in Refs. [29, 30, 43], which may be more computationally feasible to analyze in the box picture; we defer a discussion of spectroscopic surveys in the light cone picture to future work.
We model the CIB and tSZ using the Halo Model for large scale structure, combining elements of the models described in Refs. [29, 54, 61–64]. Our assumptions are outlined in detail in Appendix D. In Fig. 2, we show angular power spectra of the CIB and tSZ at several frequencies for our fiducial CMB experiment. Since all observables are computed within the same Halo Model, it is possible to capture the correlations between the CIB, tSZ, and galaxy number counts – e.g. the spectra in Fig. 2 include the CIB-tSZ cross-power. We discuss the detailed properties of the galaxy-foreground cross spectra below in Sec. 
As discussed above, there are a number of components of the CMB temperature that are correlated with tracers of large scale structure, such as the galaxy surveys considered above. Some of these contributions, such as the late-time ISW  and  extragalactic  foregrounds,  have  a  statistically  isotropic  cross-power.  On the other hand, secondary components of the CMB such as lensing, kSZ, and ML will have a statistically anisotropic cross-power with the galaxy survey. Indeed, this statistical anisotropy is the basis for velocity reconstruction. We now consider these two cases in turn

In this section, we investigate two scenarios related to the effect of foregrounds on the reconstruction. First, we investigate whether or not additional frequency channels can help with mitigating the effect of foregrounds on the reconstruction. To do so, we define a hypothetical experiment we refer to as ’Double’ SO, which has a set of channels (in GHz) at: 47, 52, 63, 75,  91,  109,  131,  158,  190,  228,  275,  330,  397, 478, 575, 691, 831, 1000. The boundaries and spacing of this selection were chosen to minimize residuals in the cleaned CMB temperature spectrum for our foreground model.  Including frequencies below     50 GHz and above 1000 GHz provides no improvement for removing extragalactic foregrounds. Our choice of 12 frequency channels in the relevant range is somewhat arbitrary, and is simply meant to be representative of a reasonable number of detectors as compared to SO. To define the noise properties of Double SO, we first take the SO LAT TT noise model [3] assumed above and define a linear interpolating function on the three free parameters in the noise model, extrapolating when necessary to higher frequencies that are not in the SO selection. We then analyzed the reconstruction noise for the fiducial N = 64 bin case assumed for SO x LSST above. In Fig. 14 we show the signal to noise for the first two principal components over a range of
 



In this work, we approximate the primary CMB, galaxy number counts, components of the velocity field, electron density, moving lens potential, and extragalactic foreground contributions to the CMB as correlated random Gaussian fields. Using the complete set of spectra and cross-spectra between these fields, we can construct a multivariate Gaussian distribution from which to drawn properly correlated realizations. These realizations can be used to compute the kSZ and moving lens contributions to the CMB. Signals constructed this way will show the  expected statistical  anisotropy  when correlated with the  galaxy density.  For  each set of realizations, the quadratic estimator for the underlying radial velocity or transverse velocity potential can be applied, allowing us to validate the statistics of the estimators by averaging over many realizations. Here is the list of steps we take to generate a suite of Gaussian simulations for radial velocity and transverse velocity potential reconstruction:

1.	Determine fields for simulation: The first step we take is to determine which fields need to be simulated ‘simultaneously”, that is, from a single multivariate Gaussian distribution capturing all the crucial correlations. Ideally, all of the cosmological fields we consider in this paper should be simulated simultaneously. This can become a difficult computational task if we want to simulate the Π-binned moments of various fields in many redshift bins, which translates into large covariance matrices with non-vanishing off-diagonal terms and many high-resolution maps. The smaller the covariance matrix, the more likely it is that numerical errors can be avoided, so there is good motivation to be as economical as possible. We can ask ourselves, for example, which fields are necessary for a simulation of the kSZ signal. Certainly, joint simulations of the Π-binned moments of the radial velocity v, the differential optical depth τ˙, and the galaxy fields g are necessary if we want to ensure that the kSZ-g cross- correlation has the correct statistical anisotropy. Having identified these completely necessary fields for velocity reconstruction, we can ask ourselves if the fields that source other forms of temperature- galaxy statistical anisotropy should also be considered in the multivariate Gaussian distribution. The analysis of Sec. IV answers this question for us: the bias introduced by the moving lens effect and the CMB lensing are negligible. This means that, for simulating radial velocity reconstruction, the moving lens and the CMB lensing signals can be simply treated as ‘effective’ sources of CMB anisotropies with no statistical correlation with the galaxy distribution. Finally, we ask ourselves if the fields that are isotropically correlated with the galaxy distribution need to be simulated together with v, τ˙ and
g.  These are the linear late-time ISW signal and the frequency cleaned extragalactic temperature
 

foregrounds. The isotropic correlation between temperature and galaxies appears in the estimator weights Eq. 35. A quick inspection shows that, for our fiducial experimental noise levels, the relative difference in these weights when the small-angle (l > 200) temperature-galaxy cross-power is ignored is at most 3%. Thus, we consider it to be safe to ignore all isotropic correlations between temperature and galaxies in the reconstruction pipeline. Summarizing, we only need to generate simultaneous simulations of the Π-binned moments of v, τ˙, and g in order to capture all the important correlations for radial velocity reconstruction. The non-kSZ CMB anisotropies can be simulated separately from a single temperature spectra and later combined with the kSZ map from the joint simulations. The considerations above also apply for the transverse velocity potential reconstruction from moving lens.


This paper has outlined the formalism for velocity reconstruction in the light cone picture using CMB experiments and galaxy surveys. One of the main goals of developing this formalism has been to explore some of the challenges posed by systematics and foregrounds for velocity reconstruction. The range of effects we have explored include: properly correlated extragalactic foregrounds, large-angular scale systematics in the galaxy survey, photometric redshift errors, masking of regions contaminated by galactic emission, modelling errors in the galaxy-electron correlation function (the optical depth degeneracy), biases introduced due to additional physical effects that lead to a statistically anisotropic CMB-galaxy correlation (e.g. lensing of
 
The transverse-velocity reconstruction from the moving-lens effect appears to be limited by the numerical accuracy available from HEALPix, as discussed in Sec. V D. We will address this issue in an upcoming study. Dashed orange lines correspond to expected reconstruction noise curves for lmax = 3394.


the primary CMB), biases introduced by coarse graining on the light cone (e.g. the ‘fine mode’ noise), CMB instrumental noise and beam, choice of frequency channels for cleaning extragalactic foregrounds in the CMB, and the effect of performing foreground cleaning on reconstructed maps. We have developed a numerical pipeline to compute the properly correlated auto- and cross-spectra necessary to assess this range
 

of effects. We have also developed a real-space reconstruction pipeline that we have validated using Gaussian simulations. This pipeline was used to assess the impact of systematics in real-space such as masking. The good news is that none of the systematic effects we have explored seriously degrade the fidelity of the reconstruction, indicating the promise of velocity reconstruction for extracting new cosmological information from future datasets.
Our fiducial datasets were a LSST-like galaxy survey and an SO-like CMB experiment. We also considered the data combination of the existing unWISE galaxy catalogue with SO. These choices determine factors such as: redshift error, depth of the survey, galaxy shot noise, the level of large-angular scale systematics, frequency channels assumed for the CMB experiment,  the associated level of instrumental noise and resolution,  and sky coverage. For these datasets, some of the take-away points of our analysis include:
•	The total information available in the reconstructed velocity fields (quantified by the total signal to noise) is limited mainly by the redshift error, sky coverage, and factors contributing to the Gaussian reconstruction noise (CMB instrumental noise and beam, foreground residuals, and the level of galaxy shot noise).
•	It is essential to incorporate the ‘fine mode’ noise associated with coarse-graining fields on the light cone into the estimator formalism for velocity reconstruction. This source of bias can be mitigated by ensuring that velocity reconstruction is performed in a sufficient number of bins along the radial direction. For radial velocity reconstruction in the fiducial SO x LSST scenario, it is necessary to use around 64 bins to mitigate this bias and include most of the signal to noise in the reconstruction; for transverse velocity reconstruction 32 bins is sufficient.
•	For radial velocity reconstruction, large-scale systematics in the galaxy survey have a significant ( 10%-level) effect on the total signal to noise due to the additional bin-bin correlations it introduces. There is negligible impact of this systematic on transverse velocity reconstruction.
•	The biases induced by CMB lensing and moving lens on radial velocity reconstruction are negligible; the bias introduced by CMB lensing on transverse velocity reconstruction is significant at the     10% level and should be taken into account, while the bias from kSZ is negligible.
•	From the principle components of the radial and transverse velocity reconstructions (see Figs. 15, 19), most of the signal to noise in the reconstruction comes from large angular scales L 4 30 and redshifts z 4 1.
•	For SO x unWISE, it is possible to reconstruct a single  principal  component  on  the  very  largest angular scales. This demonstrates that even for a single broad photometric redshift bin it is possible to reconstruct the large-scale radial velocity field. For the SO x unWISE data combination, it will not be possible to reconstruct the transverse velocity field.
•	The real space estimators for velocity reconstruction are highly local, and contamination from masking is restricted to the region in close proximity to the mask. It is therefore possible to remove the mask bias by extending the mask post-reconstruction.
•	We have validated a pipeline for velocity reconstruction using Gaussian simulations. While the nu- merical errors for radial velocity reconstruction were small, they are significant for transverse velocity reconstruction. Resolving the observed problems with numerical errors will require improved tech- niques for accurate harmonic transforms. This pipeline can serve as a prototype for analysis of future datasets, which we will pursue in future work.
•	On the full sky, we demonstrated the utility of the principal components of the reconstruction. The principal component maps are signal dominated over a wide range of angular scales with a redshift distribution that is easy to visualize. To produce similar maps on the masked sky, it will be necessary to develop methods in map-space as opposed to the harmonic-space methods introduced here, which we will pursue in future work.
The code used to produce the results presented in this paper, ReCCO, can be found at: https:// github.com/jcayuso/ReCCO.
 

A fundamental assumption of the quadratic estimator formalism explored in this paper is that the un- derlying fields are Gaussian. On the small-scales that contribute the most to the quadratic estimators, this assumption is far from accurate. One consequence is the presence of the ‘N (3/2) bias’, explored by Ref. [43] in the box picture.  We have not performed an analysis of this contribution in the light cone picture, although a similar computation based on the Halo Model could in principle be performed (albeit with complex projec- tion integrals to contend with). This may be a necessary ingredient for using velocity reconstruction in the light cone picture to measure and constrain cosmological parameters, although Ref. [43] showed that it can be neglected for constraints on primordial non-Gaussianity. A more comprehensive assessment of the effect on a variety of cosmological parameters should be performed. Aside from this bias, both Refs. [43] and [45] demonstrated that velocity reconstruction essentially works as advertised even for non-linear N-body simu- lations. An important future analysis will be to directly compare the importance of the various systematic effects discussed in this paper between Gaussian and non-linear N-body simulated datasets.
In the future, our framework can be extended to assess velocity reconstruction using different tracers such as the CIB [54] or intensity maps [35]. Other extensions include velocity reconstruction using reionization kSZ and 21cm maps [58] or reconstruction of the remote quadrupole field [28, 92]. Having a unifying framework, or at least a unifying basis, allows one to combine the cosmological information from these various probes. Examples where this may be important include constraints on modified gravity [32] and various early-Universe scenarios [33].
We foresee a cosmological paradigm shift, in which reconstruction of the lensing potential, velocity fields and the remote quadrupole field will provide the most precise tests of fundamental physics. This use of CMB secondaries to extract cosmological information through various cross-correlations is in some sense ’free information’, since these analyses rely on data from already planned CMB experiments and galaxy surveys. However, as these techniques mature, they may motivate an even stronger push towards the low- noise, high-resolution frontier with future CMB experiments.  We continue to explore the possibilities in future work.


Acknowledgments

We thank S. Ferraro, A. Krolewski, M. Madhavacheril, J. Mertens, M. Munchmeyer, and E. Schaan for useful conversations and input at various stages of this project. MCJ is supported by the National Science and Engineering Research Council through a Discovery grant. This research was supported in part by Perimeter Institute for Theoretical Physics. Research at Perimeter Institute is supported by the Government of Canada through the Department of Innovation, Science and Economic Development Canada and by the Province of Ontario through the Ministry of Research, Innovation and Science. This work was completed in part at the Aspen Center for Physics, which is supported by National Science Foundation grant PHY-1607611. SCH is supported by the Horizon Fellowship from Johns Hopkins University. SCH also acknowledges the support of a grant from the Simons Foundation at the Aspen Center for Physics, Imperial College President’s Fellowship and a postdoctoral fellowship from Imperial College London. SCH would like to thank Imperial College High Performance Computing Service at Imperial College London (UK) for providing computational resources at various early stages of this project. Some of the results in this paper have been derived using the HEALPix package [93].


scales for SO and Double SO x LSST. It can be seen that the Double SO experiment (true to its name) yields a signal to noise that is about twice as good as SO. This is due to a combination of a lower effective noise in the auto-power as well as a reduction of foreground residuals in the cross-power. This result illustrates the great room for progress in velocity reconstruction with future instruments.

